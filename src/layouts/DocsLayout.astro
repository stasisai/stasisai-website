---
import Layout from './Layout.astro';
import Header from '../components/Header.astro';
import Search from "astro-pagefind/components/Search";

interface Props {
  title: string;
  description?: string;
  currentSlug?: string;
  headings?: { depth: number; slug: string; text: string }[];
}

const { title, description, currentSlug, headings = [] } = Astro.props;

const navGroups = [
  {
    title: 'Getting Started',
    items: [
      { label: 'Introduction', slug: 'getting-started/introduction' },
      { label: 'Architecture', slug: 'getting-started/architecture' },
      { label: 'Quick Start', slug: 'getting-started/quick-start' }
    ]
  },
  {
    title: 'Engine & ECS (Bevy)',
    items: [
      { label: 'Core ECS Design', slug: 'engine-ecs/core-design' },
      { label: 'Agent Components', slug: 'engine-ecs/agent-components' },
      { label: 'Grid Structures', slug: 'engine-ecs/grid-structures' }
    ]
  },
  {
    title: 'MAPF Solvers',
    items: [
      { label: 'CBS', slug: 'solvers/cbs' },
      { label: 'PIBT', slug: 'solvers/pibt' }
    ]
  },
  {
    title: 'Fault Mechanics',
    items: [
      { label: 'Chaos Engineering', slug: 'fault-engine/chaos-engineering' },
      { label: 'Crash Faults', slug: 'fault-engine/crash-faults' },
      { label: 'Delay Faults', slug: 'fault-engine/delay-faults' }
    ]
  },
  {
    title: 'Scenarios',
    items: [
      { label: 'Scenario Loading', slug: 'scenarios/scenario-loading' },
      { label: 'Replays', slug: 'scenarios/deterministic-replays' }
    ]
  }
];

const flatItems = navGroups.flatMap(g => g.items);
const currentIndex = flatItems.findIndex(i => i.slug === currentSlug);

const prevPage = currentIndex > 0 ? flatItems[currentIndex - 1] : null;
const nextPage = currentIndex !== -1 && currentIndex < flatItems.length - 1 ? flatItems[currentIndex + 1] : null;
---

<Layout title={`${title} | MAFIS Docs`}>
  <Header />

  <div class="docs-container wrapper-grid">
    <!-- Mobile Topbar for Docs Menu -->
    <div class="docs-mobile-topbar hidden-desktop">
      <button class="docs-menu-btn" id="docs-menu-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        Chapters
      </button>
    </div>

    <!-- Desktop/Mobile Sidebar -->
    <aside class="docs-sidebar" id="docs-sidebar">
      <div class="sidebar-inner">
        <div class="search-wrapper">
          <Search id="search" className="pagefind-ui" uiOptions={{ showImages: false }} />
        </div>
        
        {navGroups.map(group => {
          // Auto-expand the category if one of its items is the current page
          const hasActive = group.items.some(item => currentSlug === item.slug);
          return (
            <details class="sidebar-group" open={hasActive || undefined}>
              <summary class="group-title">
                {group.title}
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="chevron"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </summary>
              <ul class="group-list">
                {group.items.map(item => {
                  const isActive = currentSlug === item.slug;
                  return (
                    <li>
                      <a 
                        href={`/docs/${item.slug}`} 
                        class={`sidebar-link ${isActive ? 'active' : ''}`}
                      >
                        {item.label}
                      </a>
                    </li>
                  );
                })}
              </ul>
            </details>
          );
        })}
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="docs-main">
      <article class="prose-container">
        <h1>{title}</h1>
        {description && <p class="lead-desc">{description}</p>}
        <!-- Markdown injected here -->
        <slot />
        
        <!-- Pagination -->
        <nav class="docs-pagination">
          {prevPage ? (
            <a href={`/docs/${prevPage.slug}`} class="page-nav prev">
              <span class="nav-dir">← Previous</span>
              <span class="nav-label">{prevPage.label}</span>
            </a>
          ) : <div></div>}
          
          {nextPage ? (
            <a href={`/docs/${nextPage.slug}`} class="page-nav next">
              <span class="nav-dir">Next →</span>
              <span class="nav-label">{nextPage.label}</span>
            </a>
          ) : <div></div>}
        </nav>
      </article>
    </main>

    <!-- Right Sidebar (Table of Contents) -->
    {headings.length > 0 && (
      <aside class="docs-toc">
        <div class="toc-inner">
          <span class="toc-title">On this page</span>
          <ul class="toc-list">
            {headings.filter(h => h.depth <= 3).map(heading => (
              <li class={`toc-item depth-${heading.depth}`}>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    )}
  </div>
</Layout>

<script is:inline>
  const initDocsUX = () => {
    // 1. Restore <details> state
    const stateStr = sessionStorage.getItem('sidebarState');
    if (stateStr) {
      try {
        const state = JSON.parse(stateStr);
        const details = document.querySelectorAll('details.sidebar-group');
        details.forEach((d, i) => {
          if (state[i] !== undefined) {
             d.open = state[i];
          }
        });
      } catch(e) {}
    }

    // 2. Mobile Menu Toggle
    const menuBtn = document.getElementById('docs-menu-btn');
    const sidebar = document.getElementById('docs-sidebar');
    if (menuBtn && sidebar) {
      menuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
      });
      // Close when clicking a link on mobile
      const links = sidebar.querySelectorAll('.sidebar-link');
      links.forEach(l => l.addEventListener('click', () => {
        if(window.innerWidth < 768) {
          sidebar.classList.remove('open');
        }
      }));
    }

    // 3. Inject Copy Buttons in Code Blocks
    const codeBlocks = document.querySelectorAll('.astro-code');
    codeBlocks.forEach(block => {
      // Avoid adding multiple buttons
      if(block.querySelector('.copy-btn')) return;
      
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
      btn.title = "Copy code";
      
      btn.addEventListener('click', async () => {
        const code = block.querySelector('code');
        if (code) {
          await navigator.clipboard.writeText(code.innerText);
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 2000);
        }
      });
      
      block.appendChild(btn);
    });
  };

  // Setup sidebar state persistence with view transitions
  document.addEventListener('astro:before-swap', () => {
    const details = document.querySelectorAll('details.sidebar-group');
    const state = Array.from(details).map(d => d.open);
    sessionStorage.setItem('sidebarState', JSON.stringify(state));
  });

  document.addEventListener('astro:page-load', initDocsUX);
  
  if (document.readyState === 'complete') {
      initDocsUX();
  } else {
      document.addEventListener('DOMContentLoaded', initDocsUX);
  }
</script>

<style>
  /* Subtle Grid Pattern */
  .wrapper-grid {
    background-color: var(--bg);
    background-image: 
      linear-gradient(rgba(128,128,128,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(128,128,128,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    background-position: center top;
  }

  .docs-container {
    display: flex;
    min-height: 100vh;
    padding-top: 60px; /* Aligned with header height to remove dead space */
  }

  /* ─── Mobile Docs Topbar ─── */
  .docs-mobile-topbar {
    display: none;
    padding: 12px 24px;
    background: rgba(245,242,238,0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    position: sticky;
    top: 60px; /* Below main header */
    z-index: 90;
  }
  .docs-menu-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: none;
    font-family: var(--mono);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.1em;
    cursor: pointer;
    color: var(--dark);
  }
  @media (max-width: 767px) {
    .docs-mobile-topbar { display: flex; }
    .docs-container { display: flex; flex-direction: column; }
  }

  /* ─── Sidebar ─── */
  .docs-sidebar {
    width: 280px;
    flex-shrink: 0;
    border-right: 1px solid rgba(128,128,128,0.06);
    background-color: var(--surface); /* Slightly transparent to let grid show */
    backdrop-filter: blur(10px);
    
    /* Default offcanvas for mobile */
    position: fixed;
    top: 108px; /* 60px header + 48px topbar */
    bottom: 0;
    left: 0;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
  }
  .docs-sidebar.open {
    transform: translateX(0);
    box-shadow: 10px 0 30px rgba(0,0,0,0.05);
  }

  @media (min-width: 768px) {
    .docs-sidebar {
      position: relative;
      top: 0;
      transform: translateX(0);
      width: 220px; /* Slim on tablet */
      display: block;
    }
    .hidden-desktop { display: none; }
    .docs-container { border-top: 1px solid transparent; } /* Realign flex row */
  }
  @media (min-width: 1024px) {
    .docs-sidebar { width: 280px; }
  }

  .sidebar-inner {
    padding: 32px 24px;
    position: sticky;
    top: 60px;
    max-height: calc(100vh - 60px);
    overflow-y: auto;
  }
  
  .search-wrapper {
    margin-bottom: 24px;
    line-height: 1; /* Avoids strange vertical rhythm stacking on astro pagefind component */
  }
  
  /* Custom PageFind styles to match theme */
  :global(.pagefind-ui) {
    --pagefind-ui-scale: 0.65 !important; /* Made smaller */
    --pagefind-ui-primary: var(--dark) !important;
    --pagefind-ui-text: var(--text) !important;
    --pagefind-ui-background: var(--bg) !important;
    --pagefind-ui-border: rgba(128,128,128,0.2) !important;
    --pagefind-ui-border-width: 1px !important;
    --pagefind-ui-border-radius: 6px !important;
    --pagefind-ui-font: var(--sans) !important;
  }
  :global(.pagefind-ui .pagefind-ui__search-input) {
    font-weight: 400 !important;
  }

  .sidebar-group {
    margin-bottom: 8px;
  }

  /* Remove default summary marker */
  .sidebar-group summary::-webkit-details-marker {
    display: none;
  }
  .sidebar-group summary {
    list-style: none;
  }

  .group-title {
    font-family: var(--mono);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-sec);
    padding: 12px 0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(128,128,128,0.04);
    transition: color 0.2s;
  }
  .group-title:hover {
    color: var(--dark);
  }

  .chevron {
    transform: rotate(-90deg);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  details[open] .chevron {
    transform: rotate(0deg);
  }

  .group-list {
    list-style: none;
    padding: 12px 0 16px 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
    animation: slideDown 0.3s ease-out forwards;
    transform-origin: top;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px) scaleY(0.95); }
    to { opacity: 1; transform: translateY(0) scaleY(1); }
  }

  .sidebar-link {
    font-family: var(--sans);
    font-size: 0.9rem;
    color: var(--text-sec);
    text-decoration: none;
    display: block;
    padding: 8px 12px;
    border-radius: 6px;
    margin-left: -12px; /* Pull into padding to align text visually */
    transition: all 0.2s;
  }
  
  .sidebar-link:hover {
    color: var(--dark);
    background-color: rgba(0,0,0,0.04);
    transform: translateX(4px);
  }

  .sidebar-link.active {
    color: var(--dark);
    font-weight: 500;
    background-color: rgba(0,0,0,0.06);
    border-left: 2px solid var(--dark);
    border-radius: 0 6px 6px 0;
    padding-left: 10px;
  }

  /* ─── Main Content ─── */
  .docs-main {
    flex: 1;
    padding: 32px 24px 80px;
    min-width: 0; /* Prevents overflow */
  }

  @media (min-width: 768px) {
    .docs-main { padding: 48px 40px; }
  }
  @media (min-width: 1024px) {
    .docs-main { padding: 48px 80px; }
  }

  /* Custom Prose Styles for Markdown (Tech-Editorial) */
  .prose-container {
    max-width: 760px;
    margin: 0 auto;
  }
  
  /* ALL Headers in Playfair Display */
  .prose-container :global(h1),
  .prose-container :global(h2),
  .prose-container :global(h3),
  .prose-container :global(h4),
  .prose-container :global(h5) {
    font-family: var(--serif);
    color: var(--dark);
    letter-spacing: -0.5px;
  }

  .prose-container :global(h1) {
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    letter-spacing: -1.5px;
    margin-bottom: 16px;
    line-height: 1.1;
  }

  .prose-container :global(h2) {
    font-size: 2rem;
    margin-top: 56px;
    margin-bottom: 24px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 8px;
  }

  .prose-container :global(h3) {
    font-size: 1.5rem;
    margin-top: 40px;
    margin-bottom: 16px;
  }

  .prose-container :global(h4) {
    font-size: 1.25rem;
    margin-top: 32px;
    margin-bottom: 12px;
  }

  .lead-desc {
    font-family: var(--sans);
    font-size: 1.1rem;
    color: var(--text-sec);
    line-height: 1.6;
    margin-bottom: 48px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 32px;
  }

  .prose-container :global(p) {
    font-family: var(--sans);
    font-size: 1rem;
    color: var(--text);
    line-height: 1.8;
    margin-bottom: 24px;
  }

  .prose-container :global(ul), .prose-container :global(ol) {
    padding-left: 24px;
    margin-bottom: 24px;
    font-family: var(--sans);
    line-height: 1.7;
    color: var(--text);
  }
  
  .prose-container :global(li) {
    margin-bottom: 8px;
  }

  .prose-container :global(strong) {
    font-weight: 600;
    color: var(--dark);
  }

  .prose-container :global(blockquote) {
    border-left: 3px solid var(--dark);
    padding-left: 24px;
    margin-left: 0;
    font-style: italic;
    color: var(--text-sec);
    background: rgba(0,0,0,0.02);
    padding: 16px 24px;
    border-radius: 0 8px 8px 0;
  }
  .prose-container :global(blockquote p) {
    margin-bottom: 0;
  }

  /* ─── Code Blocks (Rust compatibility) ─── */
  /* Astro uses Shiki for code highlighting automatically, we just style the wrapper */
  .prose-container :global(.astro-code),
  .prose-container :global(pre) {
    background-color: #1A1A1A !important; /* Dark solid background for contrast */
    color: #E5E5E5;
    padding: 24px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 32px 0;
    font-family: var(--mono);
    font-size: 0.9rem;
    line-height: 1.5;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.05);
    position: relative;
  }
  
  .prose-container :global(.copy-btn) {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    color: #a0a0a0;
    padding: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .prose-container :global(.copy-btn:hover) {
    background: rgba(255,255,255,0.2);
    color: #fff;
  }
  .prose-container :global(.copy-btn.copied) {
    color: var(--green);
    border-color: var(--green);
  }

  /* Inline code snippets */
  .prose-container :global(code) {
    font-family: var(--mono);
    background: rgba(0,0,0,0.06);
    color: var(--red); /* Techy accent color */
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85em;
  }

  .prose-container :global(pre code) {
    background: transparent;
    color: inherit;
    padding: 0;
    border-radius: 0;
  }

  /* ─── Pagination ─── */
  .docs-pagination {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid rgba(128,128,128,0.1);
    display: flex;
    justify-content: space-between;
    gap: 24px;
  }
  
  .page-nav {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    padding: 16px 24px;
    border: 1px solid rgba(128,128,128,0.08);
    border-radius: 8px;
    background: var(--surface);
    transition: all 0.2s ease;
    flex: 1;
  }
  
  .page-nav.prev {
    align-items: flex-start;
  }
  
  .page-nav.next {
    align-items: flex-end;
    text-align: right;
  }
  
  .page-nav:hover {
    border-color: rgba(0,0,0,0.2);
    background: rgba(0,0,0,0.02);
    transform: translateY(-2px);
  }
  
  .nav-dir {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-sec);
    margin-bottom: 8px;
  }
  
  .nav-label {
    font-family: var(--serif);
    font-size: 1.25rem;
    color: var(--dark);
  }

  /* ─── Right Sidebar Table of Contents ─── */
  .docs-toc {
    width: 200px;
    flex-shrink: 0;
    display: none; /* hidden on mobile/tablet */
    padding: 48px 24px 48px 0;
  }
  @media (min-width: 1100px) {
    .docs-toc { display: block; }
  }
  
  .toc-inner {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
  }
  
  .toc-title {
    font-family: var(--mono);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--dark);
    font-weight: 600;
    margin-bottom: 16px;
    display: block;
  }
  
  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .toc-item a {
    font-family: var(--sans);
    font-size: 0.85rem;
    color: var(--text-sec);
    text-decoration: none;
    transition: color 0.2s;
    line-height: 1.4;
    display: block;
  }
  
  .toc-item a:hover {
    color: var(--dark);
  }
  
  .toc-item.depth-3 {
    padding-left: 12px;
  }
</style>

